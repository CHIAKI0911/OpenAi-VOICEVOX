<!DOCTYPE html>
<html>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

<head>
    <title>おしゃべりずんだもん</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        header {
            background-color: #00793D;
        }

        h1 {
            color: white;
            font-family: "Meiryo";
        }

        body {
            background-color: #B2D8B2;
            text-align: center; /* 要素を水平方向に中央揃え */
        }

        #userInput {
            font-size: 20px; /* テキストボックスのフォントサイズ */
            padding: 10px; /* テキストボックスの内側の余白 */
            width: 300px; /* テキストボックスの幅 */
            height: 40px; /* テキストボックスの高さ */
        }

        #submitBtn {
            font-size: 20px; /* ボタンのフォントサイズ */
            padding: 10px 20px; /* ボタンの内側の余白（上下 左右） */
            width: 200px; /* ボタンの幅 */
            height: 50px; /* ボタンの高さ */
            background-color: #00793D; /* ボタンの背景色 */
            color: white; /* ボタンのテキスト色 */
            border: none; /* ボタンの境界線を非表示にする */
            border-radius: 5px; /* ボタンの角の丸み */
        }

        #chatContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #chatContainer img {
            max-width: 50%;
        }

        .chatBubble {
            background-color: #F2F2F2;
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .chatBubble p {
            font-size: 16px;
            margin: 0;
        }

    </style>
</head>

<body>
    <header>
        <h1>おしゃべりずんだもん</h1>
    </header>

    <form id="userInputForm">
        <input type="text" placeholder="質問を入力してください" id="userInput" name="user_input">
        <button type="submit">送信</button>
    </form>

    <div id="responseContainer">
        <div id="chatContainer">
            <img src="{{ url_for('static', filename='images/default-zundamon.png') }}">
            <div id="chatHistory"></div>
        </div>
        <audio id="audioPlayer" controls></audio> <!-- 音声を再生するための要素 -->
        <a href="https://github.com/Hiroshiba/voicevox" target="_blank"><br>VOICEVOX:ずんだもん<br>立ち絵：坂本アヒル 様</a>
    </div>

    <script>
       // 質問と回答の会話を保持する配列
var conversation = [];

// フォームが送信されたときの処理
$('#userInputForm').submit(function (event) {
    event.preventDefault(); // ページ遷移を防止

    var userInput = $('#userInput').val(); // 入力値を取得

    // AJAXリクエストを送信して音声と回答を取得
    $.post('/', { user_input: userInput }, function (response) {
        // 会話の配列に質問と回答を追加
        conversation.push({ question: userInput, answer: response.response });

        // 会話を表示する
        displayConversation();

         // 音声ファイルを再生する
        var audioPlayer = $('#audioPlayer')[0];
        audioPlayer.src = response.audio_file;
        audioPlayer.load();

        // 音声ファイルがロードされたら再生を開始
        audioPlayer.addEventListener('canplaythrough', function() {
            audioPlayer.play();
        }, { once: true }); // once オプションを true にすることで、イベントが一度だけ実行されるようになります


        // 追加の音声再生
        var audio = new Audio('/audio/audio.wav');
        audio.play();
    });

    // テキストボックスをクリア
    $('#userInput').val('');
});

// 会話を表示する関数
function displayConversation() {
    var chatHistory = $('#chatHistory');
    chatHistory.empty(); // 会話の履歴をクリア

    // 会話の配列をループして会話を表示
    for (var i = 0; i < conversation.length; i++) {
        var question = conversation[i].question;
        var answer = conversation[i].answer;

        // 質問と回答を会話形式で表示
        var questionBubble = $('<div class="chatBubble"></div>');
        var questionText = $('<p></p>').text('ユーザー: ' + question);
        questionBubble.append(questionText);

        var answerBubble = $('<div class="chatBubble"></div>');
        var answerText = $('<p></p>').text(answer);
        answerBubble.append(answerText);

        chatHistory.append(questionBubble, answerBubble);
    }
}

    </script>
</body>

</html>
